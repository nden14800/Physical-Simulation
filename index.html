<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物理シミュレーション (高画質版)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- p5.jsライブラリをインポート -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.1/p5.min.js"></script>
    <style>
        /* CSSカスタムプロパティの定義 (ライトモードデフォルト) */
        :root {
            --bg-color: #f0f0f0;
            --text-color: #333;
            --primary-accent-color: #007bff; /* ボールの色など */
            --border-color: #333;
            --simulation-bg-color: #fff;
            --controls-text-color: #333;
            --controls-border-color: #ccc;
            --button-bg-color: #f9f9f9;
            --button-hover-bg-color: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.1);
            --input-bg-color: #fff;
        }

        /* ダークモード時のカスタムプロパティ上書き */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1e1e1e;
                --text-color: #e0e0e0;
                --primary-accent-color: #42a5f5; /* ダークモード用に少し明るい青に */
                --border-color: #777;
                --simulation-bg-color: #2c2c2c;
                --controls-text-color: #e0e0e0;
                --controls-border-color: #555;
                --button-bg-color: #3a3a3a;
                --button-hover-bg-color: #505050;
                --shadow-color: rgba(255,255,255,0.08);
                --input-bg-color: #3a3a3a;
            }
        }

        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden; /* スクロールバーを隠す */
            transition: background-color 0.3s ease, color 0.3s ease; /* スムーズなテーマ切り替え */
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 20px;
        }
        
        /* p5.jsが生成するcanvasを配置するコンテナ */
        #simulationArea {
            width: 600px;
            height: 400px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            /* p5.jsによってcanvasが中に入るため、背景色は不要 */
        }

        #simulationArea canvas {
            display: block; /* canvas下の余分なスペースを削除 */
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center; /* ラベルとスライダーの縦位置合わせ */
        }

        .controls button, .controls input[type="range"], .controls label {
            font-family: 'Roboto', sans-serif;
            padding: 8px 12px;
            border: 1px solid var(--controls-border-color);
            border-radius: 4px;
            color: var(--controls-text-color);
            background-color: var(--button-bg-color); /* ボタンにも背景色適用 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .controls button {
            cursor: pointer;
        }
        .controls button:hover {
            background-color: var(--button-hover-bg-color);
        }
        .controls input[type="range"] {
            cursor: grab;
            padding: 0; /* スライダーの余分なパディング削除 */
            background-color: transparent; /* スライダーのトラック背景を透明に */
        }
        .controls label {
            background-color: transparent; /* ラベルの背景は透明 */
            border: none; /* ラベルの枠線は不要 */
            padding-left: 0;
            padding-right: 5px;
        }
    </style>
</head>
<body>
    <h1>バウンドボールシミュレーション</h1>

    <!-- p5.jsがこのdivの中にcanvasを生成します -->
    <div id="simulationArea"></div>

    <div class="controls">
        <button id="startButton">開始</button>
        <button id="resetButton">リセット</button>
        <label for="gravitySlider">重力: <span id="gravityValue">0.20</span></label>
        <input type="range" id="gravitySlider" min="0.05" max="1" step="0.01" value="0.2">
        <label for="restitutionSlider">反発係数: <span id="restitutionValue">0.80</span></label>
        <input type="range" id="restitutionSlider" min="0.1" max="0.99" step="0.01" value="0.8">
    </div>

    <script>
        // DOM要素の参照
        const simulationArea = document.getElementById('simulationArea');
        const startButton = document.getElementById('startButton');
        const resetButton = document.getElementById('resetButton');
        const gravitySlider = document.getElementById('gravitySlider');
        const restitutionSlider = document.getElementById('restitutionSlider');
        const gravityValueSpan = document.getElementById('gravityValue');
        const restitutionValueSpan = document.getElementById('restitutionValue');

        // ボールのプロパティ
        const ballRadius = 15; // ボールの半径 (px)
        let x, y; // 位置
        let vx, vy; // 速度

        // シミュレーションパラメータ
        let gravity = parseFloat(gravitySlider.value);
        let restitution = parseFloat(restitutionSlider.value);
        let friction = 0.995; // 摩擦係数

        let isRunning = false;

        // ボールの状態を初期化する関数
        function initializeBall() {
            x = 50 + ballRadius;
            y = 50 + ballRadius;
            vx = Math.random() * 4 + 1; // 1から5のランダムな初速
            vy = Math.random() * 2;
        }

        // p5.jsの初期化関数
        function setup() {
            const canvas = createCanvas(simulationArea.clientWidth, simulationArea.clientHeight);
            canvas.parent('simulationArea');
            
            initializeBall(); // ボールを初期化
            noLoop(); // 最初はアニメーションを停止
            draw(); // 初期状態を描画
        }

        // p5.jsのアニメーションループ関数
        function draw() {
            // CSS変数から現在のテーマの色を取得
            const style = getComputedStyle(document.documentElement);
            const simBgColor = style.getPropertyValue('--simulation-bg-color').trim();
            const ballColor = style.getPropertyValue('--primary-accent-color').trim();

            // 背景を描画
            background(simBgColor);
            
            // isRunningがtrueのときだけ物理演算を更新
            if (isRunning) {
                // 物理演算
                vy += gravity;
                x += vx;
                y += vy;

                // 壁との衝突判定
                // 下の壁
                if (y + ballRadius > height) {
                    y = height - ballRadius;
                    vy *= -restitution;
                    vx *= friction;
                }
                // 上の壁
                if (y - ballRadius < 0) {
                    y = ballRadius;
                    vy *= -restitution;
                }
                // 右の壁
                if (x + ballRadius > width) {
                    x = width - ballRadius;
                    vx *= -restitution;
                }
                // 左の壁
                if (x - ballRadius < 0) {
                    x = ballRadius;
                    vx *= -restitution;
                }
            }
            
            // ボールを描画
            noStroke(); // 枠線なし
            fill(ballColor);
            circle(x, y, ballRadius * 2);
        }
        
        // ウィンドウサイズが変更されたときに実行される関数
        function windowResized() {
            // コンテナのサイズに合わせてキャンバスをリサイズ
            resizeCanvas(simulationArea.clientWidth, simulationArea.clientHeight);
            // 画面外にはみ出したボールを中に戻す
            if (x > width - ballRadius) x = width - ballRadius;
            if (y > height - ballRadius) y = height - ballRadius;
            if (x < ballRadius) x = ballRadius;
            if (y < ballRadius) y = ballRadius;
            
            // リサイズ後も静的な状態を再描画
            if (!isRunning) {
                draw();
            }
        }

        // --- イベントリスナー ---

        startButton.addEventListener('click', () => {
            isRunning = !isRunning; // 状態を反転
            if (isRunning) {
                startButton.textContent = '一時停止';
                loop(); // p5.jsのアニメーションループを開始
            } else {
                startButton.textContent = '再開';
                noLoop(); // p5.jsのアニメーションループを停止
            }
        });

        resetButton.addEventListener('click', () => {
            isRunning = false;
            startButton.textContent = '開始';
            noLoop();
            initializeBall();
            draw(); // リセット後の初期状態をすぐに描画
        });

        gravitySlider.addEventListener('input', (event) => {
            gravity = parseFloat(event.target.value);
            gravityValueSpan.textContent = gravity.toFixed(2);
        });

        restitutionSlider.addEventListener('input', (event) => {
            restitution = parseFloat(event.target.value);
            restitutionValueSpan.textContent = restitution.toFixed(2);
        });

        // 初期値の表示を更新
        gravityValueSpan.textContent = gravity.toFixed(2);
        restitutionValueSpan.textContent = restitution.toFixed(2);

    </script>
</body>
</html>
